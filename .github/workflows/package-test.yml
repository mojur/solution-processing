name: Test package

on:
  push:
    branches: [ master ]
    paths: [ '**.cs', 'package.json' ]
  pull_request:
    branches: [ master ]
    paths: [ '**.cs', 'package.json' ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository ğŸ‘“ğŸ“—
        uses: actions/checkout@v2

      - name: Wrap package in project ğŸŒ¯
        run: bash ./.github/workflows/scripts/projectize-package.sh

      - name: Cache large unity folders â˜ğŸ”½ğŸ’¾
        uses: actions/cache@v2
        with:
          path: Library
          key: unity-cache

      - name: Run tests ğŸ‘¨â€ğŸ”¬
        id: project-test
        uses: webbertakken/unity-test-runner@v1 # Fails if any test fails
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        continue-on-error: true # Upload even if some tests fail

      - name: Upload test results ğŸ–¨
        uses: actions/upload-artifact@v2
        with:
          name: Test results
          path: ${{ steps.project-test.outputs.artifactsPath }}

      - name: Verify all tests passed ğŸ’¯â‰
        run: bash ./.github/workflows/scripts/verify-none-failed.sh ${{ steps.project-test.outputs.artifactsPath }}
